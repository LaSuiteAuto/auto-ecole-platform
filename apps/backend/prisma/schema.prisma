generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Tenant {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())

  users     User[]
  students  Student[]
  auditLogs AuditLog[]
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  role      UserRole
  tenantId  String

  tenant    Tenant     @relation(fields: [tenantId], references: [id])
  student   Student?   // Un User peut être un Student (1-to-1 optionnel)
  auditLogs AuditLog[]

  createdAt DateTime @default(now())
}

model AuditLog {
  id           String   @id @default(uuid())
  tenantId     String
  actorUserId  String
  action       String   // Ex: "LESSON_CANCELLED", "STUDENT_ARCHIVED"
  entityType   String   // Ex: "Student", "Lesson", "Instructor"
  entityId     String   // ID de l'entité concernée
  metadata     Json?    // Données avant/après, détails supplémentaires
  createdAt    DateTime @default(now())

  tenant       Tenant   @relation(fields: [tenantId], references: [id])
  actor        User     @relation(fields: [actorUserId], references: [id])

  @@index([tenantId])
  @@index([actorUserId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

enum UserRole {
  ADMIN
  SECRETARY
  INSTRUCTOR
  STUDENT
}

enum LicenseType {
  B       // Permis B Classique
  AAC     // Apprentissage Anticipé de la Conduite (dès 15 ans)
  CS      // Conduite Supervisée (dès 18 ans)
  A1      // Moto 125cc
  A2      // Moto 
}

// 2. Enum pour le statut administratif
enum StudentStatus {
  PROSPECT
  ANTS_PROCESSING
  ACTIVE
  EXAM_READY
  LICENSE_OBTAINED
  ARCHIVED
}

model Student {
  id        String   @id @default(uuid())
  
  // Liens techniques
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id])
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])

  // --- A. IDENTITÉ (État Civil Strict) ---
  birthName    String   // Nom de naissance (Jeune fille)
  firstName    String
  birthDate    DateTime
  birthCity    String
  birthZipCode String?  // Optionnel si né à l'étranger
  birthCountry String   @default("FRANCE")

  // --- B. CONTACT & ADRESSE ---
  address      String
  city         String
  zipCode      String
  phone        String   // Portable élève

  // --- C. DOCUMENTS & CONFORMITÉ ANTS ---
  neph         String?  @unique 
  ePhotoCode   String?
  
  // Est-ce que l'élève a fourni ces documents ? (Checkboxes admin)
  hasIdCard           Boolean @default(false)
  hasProofOfAddress   Boolean @default(false) // < 6 mois
  
  // Spécifique Jeunes
  hasAssr2            Boolean @default(false) // Attestation Scolaire Sécurité Routière
  hasJdcCertificate   Boolean @default(false) // 17-25 ans
  hasCensusCertificate Boolean @default(false) // 16-17 ans

  // Spécifique Médical / Retour de permis
  needsMedicalOpinion Boolean @default(false) // Si coché, bloque l'inscription ANTS tant que pas reçu
  hasMedicalOpinion   Boolean @default(false)

  // --- D. FORMATION ---
  licenseType     LicenseType @default(B)
  status          StudentStatus @default(PROSPECT)
  
  // Compteurs Heures (Minutes préférables pour précision)
  minutesPurchased  Int @default(0)
  minutesUsed       Int @default(0)

  // --- E. REPRÉSENTANT LÉGAL (Si Mineur) ---
  // On stocke ça "à plat" pour l'instant car un parent n'est pas forcément un User
  guardianName    String?
  guardianPhone   String?
  guardianEmail   String?
  guardianRelation String? // "Père", "Mère", "Tuteur"

  // --- F. SYSTEM ---
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  archivedAt    DateTime? 

  @@index([tenantId])
  @@index([neph])
  @@index([birthName])
}